Homework 2 - P8105 Data Science I
================
Yongyan Liu (yl6107)
2025-09-30

- [Problem 1](#problem-1)
  - [Read & Clean: pols-month.csv](#read--clean-pols-monthcsv)
  - [Read & Clean: snp.csv](#read--clean-snpcsv)
  - [Read & Clean: unemployment.csv](#read--clean-unemploymentcsv)
  - [Join the datasets](#join-the-datasets)
- [Problem 2](#problem-2)
  - [Read & clean: Mr. Trash Wheel
    sheet](#read--clean-mr-trash-wheel-sheet)
  - [Read & clean: Professor Trash
    Wheel](#read--clean-professor-trash-wheel)
  - [Read & clean: Gwynns Falls Trash
    Wheel](#read--clean-gwynns-falls-trash-wheel)
  - [Combine into one dataset](#combine-into-one-dataset)
- [Problem 3](#problem-3)
  - [Import and show the raw data](#import-and-show-the-raw-data)
  - [Clean the data](#clean-the-data)
  - [Merge to the final dataset](#merge-to-the-final-dataset)
  - [Missing ZIP Codes in Zori](#missing-zip-codes-in-zori)
  - [Show price drops during
    Covid-19](#show-price-drops-during-covid-19)

``` r
library(tidyverse)
library(readxl)
library(janitor)
```

# Problem 1

## Read & Clean: pols-month.csv

First, clean the data in pols-month.csv.

- Use separate() to break up the variable mon into integer variables
  year, month, and day;
- Replace month number with month name;
- Create a president variable taking values gop and dem, and remove
  prez_dem and prez_gop;
- Remove the day variable.

``` r
pols <- read_csv(file.path("./data/fivethirtyeight", "pols-month.csv"), show_col_types = FALSE) |>
  janitor::clean_names() |>
  separate(mon, into = c("year", "month", "day"), convert = TRUE) |>
  mutate(
    month = month.name[month],
    president = if_else(prez_gop == 1, "gop", "dem")
  ) |>
  select(-prez_gop, -prez_dem, -day) |>
  # Arrange by year and calendar order of month
  mutate(month = factor(month, levels = month.name, ordered = TRUE)) |>
  arrange(year, month)
  
list(
  head_rows = head(pols, 10),
  tail_rows = tail(pols, 10)
)
```

    ## $head_rows
    ## # A tibble: 10 × 9
    ##     year month     gov_gop sen_gop rep_gop gov_dem sen_dem rep_dem president
    ##    <int> <ord>       <dbl>   <dbl>   <dbl>   <dbl>   <dbl>   <dbl> <chr>    
    ##  1  1947 January        23      51     253      23      45     198 dem      
    ##  2  1947 February       23      51     253      23      45     198 dem      
    ##  3  1947 March          23      51     253      23      45     198 dem      
    ##  4  1947 April          23      51     253      23      45     198 dem      
    ##  5  1947 May            23      51     253      23      45     198 dem      
    ##  6  1947 June           23      51     253      23      45     198 dem      
    ##  7  1947 July           23      51     253      23      45     198 dem      
    ##  8  1947 August         23      51     253      23      45     198 dem      
    ##  9  1947 September      23      51     253      23      45     198 dem      
    ## 10  1947 October        23      51     253      23      45     198 dem      
    ## 
    ## $tail_rows
    ## # A tibble: 10 × 9
    ##     year month     gov_gop sen_gop rep_gop gov_dem sen_dem rep_dem president
    ##    <int> <ord>       <dbl>   <dbl>   <dbl>   <dbl>   <dbl>   <dbl> <chr>    
    ##  1  2014 September      29      45     234      21      53     199 dem      
    ##  2  2014 October        29      45     234      21      53     199 dem      
    ##  3  2014 November       29      45     235      21      53     201 dem      
    ##  4  2014 December       29      45     235      21      53     201 dem      
    ##  5  2015 January        31      54     245      18      44     188 dem      
    ##  6  2015 February       31      54     245      18      44     188 dem      
    ##  7  2015 March          31      54     245      18      44     188 dem      
    ##  8  2015 April          31      54     244      18      44     188 dem      
    ##  9  2015 May            31      54     245      18      44     188 dem      
    ## 10  2015 June           31      54     246      18      44     188 dem

## Read & Clean: snp.csv

Second, clean the data in snp.csv using a similar process to the above.
For consistency across datasets, arrange according to year and month,
and organize so that year and month are the leading columns.

``` r
snp <- read_csv(file.path("./data/fivethirtyeight", "snp.csv"), show_col_types = FALSE) |>
  janitor::clean_names() |>
  mutate(date = mdy(date)) |>
  transmute(
    year = year(date),
    month = month.name[month(date)],
    close
  ) |>
  mutate(month = factor(month, levels = month.name, ordered = TRUE)) |>
  arrange(year, month)

list(
  head_rows = head(snp, 10),
  tail_rows = tail(snp, 10)
)
```

    ## $head_rows
    ## # A tibble: 10 × 3
    ##     year month     close
    ##    <dbl> <ord>     <dbl>
    ##  1  1969 January   103. 
    ##  2  1969 February   98.1
    ##  3  1969 March     102. 
    ##  4  1969 April     104. 
    ##  5  1969 May       103. 
    ##  6  1969 June       97.7
    ##  7  1969 July       91.8
    ##  8  1969 August     95.5
    ##  9  1969 September  93.1
    ## 10  1969 October    97.1
    ## 
    ## $tail_rows
    ## # A tibble: 10 × 3
    ##     year month     close
    ##    <dbl> <ord>     <dbl>
    ##  1  2068 March      90.2
    ##  2  2068 April      97.5
    ##  3  2068 May        98.7
    ##  4  2068 June       99.6
    ##  5  2068 July       97.7
    ##  6  2068 August     98.9
    ##  7  2068 September 103. 
    ##  8  2068 October   103. 
    ##  9  2068 November  108. 
    ## 10  2068 December  104.

## Read & Clean: unemployment.csv

Third, tidy the unemployment data so that it can be merged with the
previous datasets.

- Switching from “wide” to “long” format;
- Ensuring that key variables have the same name;
- Ensuring that key variables take the same values.

``` r
unemp <- read_csv(file.path("./data/fivethirtyeight", "unemployment.csv"), show_col_types = FALSE) |>
  pivot_longer(
    cols = Jan:Dec,
    names_to = "month",
    values_to = "unemployment"
  ) |>
  janitor::clean_names() |>
  mutate(
    month = month.name[match(month, month.abb)],
    month = factor(month, levels = month.name, ordered = TRUE)
  ) |>
  arrange(year, month)

list(
  head_rows = head(unemp, 10),
  tail_rows = tail(unemp, 10)
)
```

    ## $head_rows
    ## # A tibble: 10 × 3
    ##     year month     unemployment
    ##    <dbl> <ord>            <dbl>
    ##  1  1948 January            3.4
    ##  2  1948 February           3.8
    ##  3  1948 March              4  
    ##  4  1948 April              3.9
    ##  5  1948 May                3.5
    ##  6  1948 June               3.6
    ##  7  1948 July               3.6
    ##  8  1948 August             3.9
    ##  9  1948 September          3.8
    ## 10  1948 October            3.7
    ## 
    ## $tail_rows
    ## # A tibble: 10 × 3
    ##     year month     unemployment
    ##    <dbl> <ord>            <dbl>
    ##  1  2015 March              5.5
    ##  2  2015 April              5.4
    ##  3  2015 May                5.5
    ##  4  2015 June               5.3
    ##  5  2015 July              NA  
    ##  6  2015 August            NA  
    ##  7  2015 September         NA  
    ##  8  2015 October           NA  
    ##  9  2015 November          NA  
    ## 10  2015 December          NA

## Join the datasets

- Left-join `snp` into `pols` by `year` + `month`.
- Then left-join `unemp`.

``` r
merged_df <- left_join(pols, snp, by = c("year", "month")) |>
  mutate(snp_close = close) |>
  left_join(unemp, by = c("year", "month"))

# Since the date range of the three tables is different, some of the column 
# is NA. Let's show the rows without NA columns.
merged_df |> filter(!is.na(close) & !is.na(unemployment)) |>
  glimpse()
```

    ## Rows: 558
    ## Columns: 12
    ## $ year         <dbl> 1969, 1969, 1969, 1969, 1969, 1969, 1969, 1969, 1969, 196…
    ## $ month        <ord> January, February, March, April, May, June, July, August,…
    ## $ gov_gop      <dbl> 31, 31, 31, 31, 31, 31, 31, 31, 31, 31, 31, 31, 32, 32, 3…
    ## $ sen_gop      <dbl> 43, 43, 43, 43, 43, 43, 43, 43, 43, 43, 43, 43, 43, 43, 4…
    ## $ rep_gop      <dbl> 199, 199, 199, 199, 199, 199, 199, 199, 199, 199, 199, 19…
    ## $ gov_dem      <dbl> 22, 22, 22, 22, 22, 22, 22, 22, 22, 22, 22, 22, 20, 20, 2…
    ## $ sen_dem      <dbl> 57, 57, 57, 57, 57, 57, 57, 57, 57, 57, 57, 57, 58, 58, 5…
    ## $ rep_dem      <dbl> 250, 250, 250, 250, 250, 250, 250, 250, 250, 250, 250, 25…
    ## $ president    <chr> "gop", "gop", "gop", "gop", "gop", "gop", "gop", "gop", "…
    ## $ close        <dbl> 103.01, 98.13, 101.51, 103.69, 103.46, 97.71, 91.83, 95.5…
    ## $ snp_close    <dbl> 103.01, 98.13, 101.51, 103.69, 103.46, 97.71, 91.83, 95.5…
    ## $ unemployment <dbl> 3.4, 3.4, 3.4, 3.4, 3.4, 3.5, 3.5, 3.5, 3.7, 3.7, 3.5, 3.…

The **FiveThirtyEight datasets** describe U.S. political and economic
conditions over time.

- The **`pols-month`** data include monthly counts of national
  politicians by party across branches of government and an indicator of
  the president’s party;
- The **`snp`** data provide monthly closing values of the S&P 500
  index;
- The **`unemployment`** data contain national unemployment rates by
  month and year.

After cleaning and merging on `year` and `month`, the resulting data
frame has **822 rows** and **12 columns**, spans **1947–2015**, and
contains key variables such as `year`, `month`, `president`, `close`
(S&P 500 close), and `unemployment` (percent). This merged dataset
enables exploration of relationships between political control, stock
market performance, and labor-market conditions over time.

# Problem 2

Mr. Trash Wheel is “a water-wheel vessel that removes trash from the
Inner Harbor in Baltimore, Maryland.” It (or he) sits at an intake into
the Inner Harbor and intercepts litter and debris carried by the Jones
Falls River toward the harbor. It has removed over a million pounds of
litter since May 2014!

## Read & clean: Mr. Trash Wheel sheet

- specify the sheet in the Excel file and to omit non-data entries (rows
  with notes / figures; columns containing notes) using arguments in
  read_excel
- use reasonable variable names
- omit rows that do not include dumpster-specific data
- round the number of sports balls to the nearest integer and converts
  the result to an integer variable (using as.integer)

``` r
excel_path <- "./data/trashwheel/202509_trashwheel.xlsx"   # place this .Rmd in the same folder as the Excel

mr <- read_excel(excel_path, sheet = "Mr. Trash Wheel", skip = 1) |>
  clean_names() |>
  # drop columns that are entirely NA or are note columns like "unnamed_*"
  select(where(~ !all(is.na(.x)))) |>
  select(-starts_with("unnamed")) |>
  # keep only rows with dumpster-specific data
  filter(!is.na(dumpster)) |>
  # standardize data types and names
  mutate(
    month = as.character(month),
    year = as.integer(year),
    date = as.Date(date),
    .after = date
  ) |>
  mutate(
    sports_balls = as.integer(round(sports_balls))
  ) |>
  mutate(wheel = "Mr")
```

    ## New names:
    ## • `` -> `...15`
    ## • `` -> `...16`

``` r
glimpse(mr)
```

    ## Rows: 707
    ## Columns: 15
    ## $ dumpster           <dbl> 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, …
    ## $ month              <chr> "May", "May", "May", "May", "May", "May", "May", "M…
    ## $ year               <int> 2014, 2014, 2014, 2014, 2014, 2014, 2014, 2014, 201…
    ## $ date               <date> 2014-05-16, 2014-05-16, 2014-05-16, 2014-05-17, 20…
    ## $ weight_tons        <dbl> 4.31, 2.74, 3.45, 3.10, 4.06, 2.71, 1.91, 3.70, 2.5…
    ## $ volume_cubic_yards <dbl> 18, 13, 15, 15, 18, 13, 8, 16, 14, 18, 15, 19, 15, …
    ## $ plastic_bottles    <dbl> 1450, 1120, 2450, 2380, 980, 1430, 910, 3580, 2400,…
    ## $ polystyrene        <dbl> 1820, 1030, 3100, 2730, 870, 2140, 1090, 4310, 2790…
    ## $ cigarette_butts    <dbl> 126000, 91000, 105000, 100000, 120000, 90000, 56000…
    ## $ glass_bottles      <dbl> 72, 42, 50, 52, 72, 46, 32, 58, 49, 75, 38, 45, 58,…
    ## $ plastic_bags       <dbl> 584, 496, 1080, 896, 368, 672, 416, 1552, 984, 448,…
    ## $ wrappers           <dbl> 1162, 874, 2032, 1971, 753, 1144, 692, 3015, 1988, …
    ## $ sports_balls       <int> 7, 5, 6, 6, 7, 5, 3, 6, 6, 7, 6, 8, 6, 6, 6, 6, 5, …
    ## $ homes_powered      <dbl> 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, …
    ## $ wheel              <chr> "Mr", "Mr", "Mr", "Mr", "Mr", "Mr", "Mr", "Mr", "Mr…

## Read & clean: Professor Trash Wheel

``` r
prof <- read_excel(excel_path, sheet = "Professor Trash Wheel", skip = 1) |>
  clean_names() |>
  select(where(~ !all(is.na(.x)))) |>
  select(-starts_with("unnamed")) |>
  filter(!is.na(dumpster)) |>
  mutate(
    month = as.character(month),
    year = as.integer(year),
    date = as.Date(date),
    .after = date
  ) |>
  mutate(wheel = "Professor")

glimpse(prof)
```

    ## Rows: 132
    ## Columns: 14
    ## $ dumpster           <dbl> 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, …
    ## $ month              <chr> "January", "January", "February", "February", "Febr…
    ## $ year               <int> 2017, 2017, 2017, 2017, 2017, 2017, 2017, 2017, 201…
    ## $ date               <date> 2017-01-02, 2017-01-30, 2017-02-26, 2017-02-26, 20…
    ## $ weight_tons        <dbl> 1.79, 1.58, 2.32, 3.72, 1.45, 1.71, 1.82, 2.37, 2.6…
    ## $ volume_cubic_yards <dbl> 15, 15, 18, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15,…
    ## $ plastic_bottles    <dbl> 1950, 9540, 8350, 8590, 7830, 8210, 9830, 9240, 954…
    ## $ polystyrene        <dbl> 6080, 11230, 9210, 1030, 9950, 10340, 11020, 8760, …
    ## $ cigarette_butts    <dbl> 19700, 17600, 12000, 13000, 16000, 14000, 17000, 15…
    ## $ glass_bottles      <dbl> 8, 14, 19, 21, 18, 23, 26, 14, 28, 22, 12, 24, 27, …
    ## $ plastic_bags       <dbl> 3100, 5630, 6430, 5870, 7450, 9560, 11500, 9970, 12…
    ## $ wrappers           <dbl> 15600, 16700, 12400, 11030, 15340, 13470, 18620, 14…
    ## $ homes_powered      <dbl> 29.83333, 26.33333, 38.66667, 62.00000, 24.16667, 2…
    ## $ wheel              <chr> "Professor", "Professor", "Professor", "Professor",…

## Read & clean: Gwynns Falls Trash Wheel

``` r
gwyn <- read_excel(excel_path, sheet = "Gwynns Falls Trash Wheel", skip = 1) |>
  clean_names() |>
  select(where(~ !all(is.na(.x)))) |>
  select(-starts_with("unnamed")) |>
  filter(!is.na(dumpster)) |>
  mutate(
    month = as.character(month),
    year = as.integer(year),
    date = as.Date(date),
    .after = date
  ) |>
  mutate(wheel = "Gwynnda")

glimpse(gwyn)
```

    ## Rows: 349
    ## Columns: 13
    ## $ dumpster           <dbl> 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, …
    ## $ month              <chr> "July", "July", "July", "July", "July", "August", "…
    ## $ year               <int> 2021, 2021, 2021, 2021, 2021, 2021, 2021, 2021, 202…
    ## $ date               <date> 2021-07-03, 2021-07-07, 2021-07-07, 2021-07-16, 20…
    ## $ weight_tons        <dbl> 0.93, 2.26, 1.62, 1.76, 1.53, 2.06, 1.90, 2.16, 2.6…
    ## $ volume_cubic_yards <dbl> 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15,…
    ## $ plastic_bottles    <dbl> 1200, 2000, 1800, 1000, 2100, 2400, 2700, 3000, 980…
    ## $ polystyrene        <dbl> 360, 240, 270, 180, 240, 360, 320, 320, 180, 42, 10…
    ## $ cigarette_butts    <dbl> 3400, 3900, 2900, 2100, 4000, 3900, 4200, 4000, 180…
    ## $ plastic_bags       <dbl> 1800, 2200, 2400, 1800, 2700, 3000, 3200, 3600, 100…
    ## $ wrappers           <dbl> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,…
    ## $ homes_powered      <dbl> 15.50000, 37.66667, 27.00000, 29.33333, 25.50000, 3…
    ## $ wheel              <chr> "Gwynnda", "Gwynnda", "Gwynnda", "Gwynnda", "Gwynnd…

## Combine into one dataset

``` r
trash <- bind_rows(mr, prof, gwyn) |>
  relocate(wheel, dumpster, month, year, date)

list(
  head = slice_head(trash, n = 10),
  tail = slice_tail(trash, n = 10)
)
```

    ## $head
    ## # A tibble: 10 × 15
    ##    wheel dumpster month  year date       weight_tons volume_cubic_yards
    ##    <chr>    <dbl> <chr> <int> <date>           <dbl>              <dbl>
    ##  1 Mr           1 May    2014 2014-05-16        4.31                 18
    ##  2 Mr           2 May    2014 2014-05-16        2.74                 13
    ##  3 Mr           3 May    2014 2014-05-16        3.45                 15
    ##  4 Mr           4 May    2014 2014-05-17        3.1                  15
    ##  5 Mr           5 May    2014 2014-05-17        4.06                 18
    ##  6 Mr           6 May    2014 2014-05-20        2.71                 13
    ##  7 Mr           7 May    2014 2014-05-21        1.91                  8
    ##  8 Mr           8 May    2014 2014-05-28        3.7                  16
    ##  9 Mr           9 June   2014 2014-06-05        2.52                 14
    ## 10 Mr          10 June   2014 2014-06-11        3.76                 18
    ## # ℹ 8 more variables: plastic_bottles <dbl>, polystyrene <dbl>,
    ## #   cigarette_butts <dbl>, glass_bottles <dbl>, plastic_bags <dbl>,
    ## #   wrappers <dbl>, sports_balls <int>, homes_powered <dbl>
    ## 
    ## $tail
    ## # A tibble: 10 × 15
    ##    wheel   dumpster month  year date       weight_tons volume_cubic_yards
    ##    <chr>      <dbl> <chr> <int> <date>           <dbl>              <dbl>
    ##  1 Gwynnda      339 July   2025 2025-07-11        2.81                 15
    ##  2 Gwynnda      340 July   2025 2025-07-15        3.67                 15
    ##  3 Gwynnda      341 July   2025 2025-07-16        3.13                 15
    ##  4 Gwynnda      342 July   2025 2025-07-17        3.54                 15
    ##  5 Gwynnda      343 July   2025 2025-07-17        3.19                 15
    ##  6 Gwynnda      344 July   2025 2025-07-18        3.2                  15
    ##  7 Gwynnda      345 July   2025 2025-07-18        3.57                 15
    ##  8 Gwynnda      346 July   2025 2025-07-18        3.47                 15
    ##  9 Gwynnda      347 July   2025 2025-07-22        2.94                 15
    ## 10 Gwynnda      348 July   2025 2025-07-22        3.07                 15
    ## # ℹ 8 more variables: plastic_bottles <dbl>, polystyrene <dbl>,
    ## #   cigarette_butts <dbl>, glass_bottles <dbl>, plastic_bags <dbl>,
    ## #   wrappers <dbl>, sports_balls <int>, homes_powered <dbl>

This Excel contains data for three trash wheels operating in Baltimore’s
waterways. After importing & cleaning the data, I combined the datasets
by adding a `wheel` identifier (`"Mr."`, `"Professor"`, and
`"Gwynnda"`). The resulting tidy dataset has **1188 observations** and
**15 variables**, spanning **2014–2025**. Key variables include

- `dumpster`: load index
- `date`/`month`/`year`: collection time
- `weight_tons` and `volume_cubic_yards`: load size
- `plastic_bottles`, `polystyrene`, `cigarette_butts`, `plastic_bags`,
  `wrappers`, `sports_balls`: material counts.

These data allow quick comparisons across wheels and over time. For
example:

- Total weight collected by **Professor Trash Wheel**: **282.3 tons**.
- Total number of **cigarette butts** collected by **Gwynnda** in **June
  2022**: **18120**.

# Problem 3

Home and rental prices have generally increased over the last decade.
Zillow, a popular website used to search for homes for sale or rent, is
uniquely positioned to provide insights into trends in the real estate
market. In response to broad interest, the company releases data for
research. In this project, we’ll look at the Zillow Observed Rent Index
(ZORI) in New York City between January 2015 and August 2024.

NYC is divided into five boroughs. Each of these boroughs is it’s own
county, and in some cases the borough name and county name differ; for
example, Manhattan is New York County. Moreover, boroughs are divided
into neighborhoods. Rental price data provided by Zillow does not
include information neighborhoods within boroughs, but can be accessed
separately.

## Import and show the raw data

``` r
zip_path  <- "./data/zillow/zip_code.csv"
zori_path <- "./data/zillow/nyc_zori.csv"

# ZIP / Neighborhood reference
zip_ref <- read_csv(zip_path, show_col_types = FALSE) %>%
  clean_names()

# Zillow ZORI by ZIP (wide by month)
zori_raw <- read_csv(zori_path, show_col_types = FALSE) %>%
  clean_names()

zip_ref
```

    ## # A tibble: 322 × 7
    ##    county state_fips county_code county_fips zip_code file_date neighborhood    
    ##    <chr>       <dbl> <chr>             <dbl>    <dbl> <chr>     <chr>           
    ##  1 Bronx          36 005               36005    10451 7/25/07   High Bridge and…
    ##  2 Bronx          36 005               36005    10452 7/25/07   High Bridge and…
    ##  3 Bronx          36 005               36005    10453 7/25/07   Central Bronx   
    ##  4 Bronx          36 005               36005    10454 7/25/07   Hunts Point and…
    ##  5 Bronx          36 005               36005    10455 7/25/07   Hunts Point and…
    ##  6 Bronx          36 005               36005    10456 7/25/07   High Bridge and…
    ##  7 Bronx          36 005               36005    10457 7/25/07   Central Bronx   
    ##  8 Bronx          36 005               36005    10458 7/25/07   Bronx Park and …
    ##  9 Bronx          36 005               36005    10459 7/25/07   Hunts Point and…
    ## 10 Bronx          36 005               36005    10460 7/25/07   Central Bronx   
    ## # ℹ 312 more rows

``` r
zori_raw
```

    ## # A tibble: 149 × 125
    ##    region_id size_rank region_name region_type state_name state city     metro  
    ##        <dbl>     <dbl>       <dbl> <chr>       <chr>      <chr> <chr>    <chr>  
    ##  1     62080         4       11368 zip         NY         NY    New York New Yo…
    ##  2     62093         7       11385 zip         NY         NY    New York New Yo…
    ##  3     62019         9       11208 zip         NY         NY    New York New Yo…
    ##  4     62046        16       11236 zip         NY         NY    New York New Yo…
    ##  5     61807        17       10467 zip         NY         NY    New York New Yo…
    ##  6     62085        18       11373 zip         NY         NY    New York New Yo…
    ##  7     62037        19       11226 zip         NY         NY    New York New Yo…
    ##  8     62018        20       11207 zip         NY         NY    New York New Yo…
    ##  9     61639        29       10025 zip         NY         NY    New York New Yo…
    ## 10     62025        32       11214 zip         NY         NY    New York New Yo…
    ## # ℹ 139 more rows
    ## # ℹ 117 more variables: county_name <chr>, x2015_01_31 <dbl>,
    ## #   x2015_02_28 <dbl>, x2015_03_31 <dbl>, x2015_04_30 <dbl>, x2015_05_31 <dbl>,
    ## #   x2015_06_30 <dbl>, x2015_07_31 <dbl>, x2015_08_31 <dbl>, x2015_09_30 <dbl>,
    ## #   x2015_10_31 <dbl>, x2015_11_30 <dbl>, x2015_12_31 <dbl>, x2016_01_31 <dbl>,
    ## #   x2016_02_29 <dbl>, x2016_03_31 <dbl>, x2016_04_30 <dbl>, x2016_05_31 <dbl>,
    ## #   x2016_06_30 <dbl>, x2016_07_31 <dbl>, x2016_08_31 <dbl>, …

## Clean the data

Try to accomodate the differences between the two csv files and merge
them.

``` r
# Unify County name by removing the tailing ' County' and map county to borough
county_to_borough <- function(x) {
  x <- as.character(x)
  x <- str_replace(x, "\\s*County$", "") # strip ' County'
  dplyr::case_when(
    x == "Bronx" ~ "Bronx",
    x == "Kings" ~ "Brooklyn",
    x == "New York" ~ "Manhattan",
    x == "Queens" ~ "Queens",
    x == "Richmond" ~ "Staten Island",
    TRUE ~ x
  )
}

# Select only necessary data from the Zip Code reference
zip_ref_clean <- zip_ref %>%
  transmute(
    county = county,
    zip = as.character(zip_code),
    neighborhood = neighborhood,
    borough = county_to_borough(county)
  ) %>%
  distinct()

zip_ref_clean
```

    ## # A tibble: 322 × 4
    ##    county zip   neighborhood               borough
    ##    <chr>  <chr> <chr>                      <chr>  
    ##  1 Bronx  10451 High Bridge and Morrisania Bronx  
    ##  2 Bronx  10452 High Bridge and Morrisania Bronx  
    ##  3 Bronx  10453 Central Bronx              Bronx  
    ##  4 Bronx  10454 Hunts Point and Mott Haven Bronx  
    ##  5 Bronx  10455 Hunts Point and Mott Haven Bronx  
    ##  6 Bronx  10456 High Bridge and Morrisania Bronx  
    ##  7 Bronx  10457 Central Bronx              Bronx  
    ##  8 Bronx  10458 Bronx Park and Fordham     Bronx  
    ##  9 Bronx  10459 Hunts Point and Mott Haven Bronx  
    ## 10 Bronx  10460 Central Bronx              Bronx  
    ## # ℹ 312 more rows

``` r
# find all the dates from the column names
date_cols <- names(zori_raw) %>% keep(~ str_detect(.x, "^x\\d{4}_\\d{2}_\\d{2}$"))

# clean zori data
zori_tidy <- zori_raw %>%
  rename(
    region_id = region_id,
    zip = region_name,
    county_name = county_name
  ) %>%
  mutate(
    zip = as.character(zip),
    borough = county_to_borough(county_name)
  ) %>%
  pivot_longer(
    cols = all_of(date_cols),
    names_to = "date",
    values_to = "zori"
  ) %>%
  mutate(
    date = as.Date(str_remove(date, "^x") %>% str_replace_all("_", "-")),
    year = lubridate::year(date),
    month = lubridate::month(date)
  ) %>%
  arrange(zip, date)
```

## Merge to the final dataset

``` r
# merge with zip_ref
nyc_final <- zori_tidy %>%
  left_join(zip_ref_clean, by = c("zip", "borough")) %>%
  relocate(borough, county, county_name, zip, neighborhood, .before = region_id)

list(
  head = slice_head(nyc_final, n = 10),
  tail = slice_tail(nyc_final, n = 10)
)
```

    ## $head
    ## # A tibble: 10 × 16
    ##    borough county county_name zip   neighborhood region_id size_rank region_type
    ##    <chr>   <chr>  <chr>       <chr> <chr>            <dbl>     <dbl> <chr>      
    ##  1 Manhat… New Y… New York C… 10001 Chelsea and…     61615      4444 zip        
    ##  2 Manhat… New Y… New York C… 10001 Chelsea and…     61615      4444 zip        
    ##  3 Manhat… New Y… New York C… 10001 Chelsea and…     61615      4444 zip        
    ##  4 Manhat… New Y… New York C… 10001 Chelsea and…     61615      4444 zip        
    ##  5 Manhat… New Y… New York C… 10001 Chelsea and…     61615      4444 zip        
    ##  6 Manhat… New Y… New York C… 10001 Chelsea and…     61615      4444 zip        
    ##  7 Manhat… New Y… New York C… 10001 Chelsea and…     61615      4444 zip        
    ##  8 Manhat… New Y… New York C… 10001 Chelsea and…     61615      4444 zip        
    ##  9 Manhat… New Y… New York C… 10001 Chelsea and…     61615      4444 zip        
    ## 10 Manhat… New Y… New York C… 10001 Chelsea and…     61615      4444 zip        
    ## # ℹ 8 more variables: state_name <chr>, state <chr>, city <chr>, metro <chr>,
    ## #   date <date>, zori <dbl>, year <dbl>, month <dbl>
    ## 
    ## $tail
    ## # A tibble: 10 × 16
    ##    borough county county_name zip   neighborhood region_id size_rank region_type
    ##    <chr>   <chr>  <chr>       <chr> <chr>            <dbl>     <dbl> <chr>      
    ##  1 Queens  <NA>   Queens Cou… 11693 <NA>             62181      8012 zip        
    ##  2 Queens  <NA>   Queens Cou… 11693 <NA>             62181      8012 zip        
    ##  3 Queens  <NA>   Queens Cou… 11693 <NA>             62181      8012 zip        
    ##  4 Queens  <NA>   Queens Cou… 11693 <NA>             62181      8012 zip        
    ##  5 Queens  <NA>   Queens Cou… 11693 <NA>             62181      8012 zip        
    ##  6 Queens  <NA>   Queens Cou… 11693 <NA>             62181      8012 zip        
    ##  7 Queens  <NA>   Queens Cou… 11693 <NA>             62181      8012 zip        
    ##  8 Queens  <NA>   Queens Cou… 11693 <NA>             62181      8012 zip        
    ##  9 Queens  <NA>   Queens Cou… 11693 <NA>             62181      8012 zip        
    ## 10 Queens  <NA>   Queens Cou… 11693 <NA>             62181      8012 zip        
    ## # ℹ 8 more variables: state_name <chr>, state <chr>, city <chr>, metro <chr>,
    ## #   date <date>, zori <dbl>, year <dbl>, month <dbl>

The final dataset contains

- **17284 observations** across **16 variables**.  
- **149 unique ZIP codes**
- **42 unique neighborhoods**

Key variables include: `borough`, `zip`, `neighborhood`, `date` and
`zori`.

## Missing ZIP Codes in Zori

``` r
zips_in_ref_not_in_zori <- setdiff(zip_ref_clean$zip, unique(zori_tidy$zip))

zips_missing_tbl <- tibble(zip = zips_in_ref_not_in_zori) %>%
  left_join(zip_ref_clean, by = "zip") %>%
  arrange(borough, zip)

zips_missing_tbl %>% slice_head(n = 30)
```

    ## # A tibble: 30 × 4
    ##    zip   county neighborhood               borough 
    ##    <chr> <chr>  <chr>                      <chr>   
    ##  1 10464 Bronx  Southeast Bronx            Bronx   
    ##  2 10474 Bronx  Hunts Point and Mott Haven Bronx   
    ##  3 10475 Bronx  Northeast Bronx            Bronx   
    ##  4 10499 Bronx  <NA>                       Bronx   
    ##  5 10550 Bronx  <NA>                       Bronx   
    ##  6 10704 Bronx  <NA>                       Bronx   
    ##  7 10705 Bronx  <NA>                       Bronx   
    ##  8 10803 Bronx  <NA>                       Bronx   
    ##  9 11202 Kings  <NA>                       Brooklyn
    ## 10 11224 Kings  Southern Brooklyn          Brooklyn
    ## # ℹ 20 more rows

Some ZIP Codes are missing from Zori data because the corresponding area
are not residential area, so there are limited rental housing.

## Show price drops during Covid-19

``` r
# It's easier to do it from raw table because the price for two dates are in the same row
zori_diff <- zori_raw %>%
  mutate(diff_2020_2021 = `x2021_01_31` - `x2020_01_31`) %>%
  arrange(diff_2020_2021) %>%
  mutate(borough = county_to_borough(county_name)) %>%
  select(zip = region_name, city, borough,
    `x2020_01_31`, `x2021_01_31`, diff_2020_2021) %>%
  slice_head(n = 10)

zori_diff
```

    ## # A tibble: 10 × 6
    ##      zip city     borough   x2020_01_31 x2021_01_31 diff_2020_2021
    ##    <dbl> <chr>    <chr>           <dbl>       <dbl>          <dbl>
    ##  1 10007 New York Manhattan       6334.       5422.          -913.
    ##  2 10069 New York Manhattan       4623.       3875.          -748.
    ##  3 10009 New York Manhattan       3406.       2692.          -714.
    ##  4 10016 New York Manhattan       3731.       3019.          -712.
    ##  5 10001 New York Manhattan       4108.       3398.          -710.
    ##  6 10002 New York Manhattan       3645.       2935.          -710.
    ##  7 10004 New York Manhattan       3150.       2444.          -706.
    ##  8 10038 New York Manhattan       3573.       2876.          -698.
    ##  9 10012 New York Manhattan       3629.       2942.          -686.
    ## 10 10010 New York Manhattan       3697.       3012.          -685.

From the result, we can see that all of the top 10 price drop happens in
Manhattan. It’s because during the pandemic, most people could work from
home, so the rental prices for residential housing near workplaces have
dropped significantly.
